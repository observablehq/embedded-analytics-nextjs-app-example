This project is an example of importing a JS module from [Observable Cloud]() using signed URLs and embedding it in a [Next.js](https://nextjs.org) project using the App router. The Observable Cloud project provides charts of the number of medals won by countries in the 2024 Olympic Games, optionally broken down by continent.

## Tour

The project uses Observable Cloud's *signed URLs* feature, which could enable secure embedding or private data apps. Here the app is public however, for demonstration purposes.

The entry point for embedding is in [`src/app/page.tsx`](https://github.com/observablehq/nextjs-observable-embed/blob/main/src/app/page.tsx), which renders on the server and includes a component to render the embed.

```tsx
<ObservableEmbed
  module="https://observablehq.observablehq.cloud/olympian-embeds/medals-chart.js"
  importName="MedalsChart"
/>
```

The `ObservableEmbed` component is imported from `src/components/observableEmbed/server.tsx`, and is a server-only component. Because of that it has access to the private key used to make signed URLs. To generate the JWT that is used in the signed URL, it uses [`jose`](https://github.com/panva/jose):

```tsx
const parsedUrl = new URL(url);
const now = Date.now();
const notBefore = now - (now % SIGNATURE_ALIGN_MS);
const notAfter = notBefore + SIGNATURE_VALIDITY_MS;
const token = await new SignJWT({"urn:observablehq:path": parsedUrl.pathname})
  .setProtectedHeader({alg: "EdDSA"})
  .setSubject("nextjs-example")
  .setNotBefore(notBefore / 1000)
  .setExpirationTime(notAfter / 1000)
  .sign(privateKey);
```

This token is then passed to the final component, `ObservableEmbedClient`, which is imported from `src/components/observableEmbed/client.tsx`. This component is a client-only component, and is responsible for rendering the embed in the browser. It uses the signed URL generated by the server to import the module from Observable Cloud, and then renders the imported component into the DOM:

```tsx
const ref = useRef<HTMLDivElement | null>(null);

useEffect(() => {
  (async () => {
    const target = ref.current;
    if (!target) return;
    while (target.firstChild) target.removeChild(target.firstChild);
    const mod = await import(/* webpackIgnore: true */ module);
    const component = mod[importName];
    const element = component instanceof Function ? await component() : component;
    target.append(element);
  })();
}, [importName, module]);

return <div ref={ref} />;
```

## Development

Install dependencies:

```sh
yarn install
```

Run the development server:

```sh
yarn dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.
